#!/usr/bin/env sh
#
# Checks for processes that need a restart after upgrading.
# Written by ayekat on a cold evening in january 2017.
#
# Based on a script written by progandy on 2014-06-12 and shared on:
# https://bbs.archlinux.org/viewtopic.php?pid=1425075#p1425075

sudo lsof -F pfn | awk '
	/^p/{
		# new process
		del = 0;
		pid = substr($0, 2);
	}
	/^fDEL$/{
		# the next file is deleted
		del = 1;
	}
	/^n/{
		# if the file is a deleted library or binary, show it
		if (del == 1 && match($0, "bin|lib")) {
			print pid " " $0;
			del = 0;
		}
		del = 0;
	}
' | sort -u | while read -r tuple; do
	pid="$(echo "$tuple" | cut -d ' ' -f 1)"
	file="$(echo "$tuple" | cut -d ' ' -f 2- | cut -c 2-)"
	printf "\033[34m%5d\033[0m %s â†’ \033[31m%s\033[0m\n" \
		"$pid" "$(ps --no-headers --format '%a' -p "$pid")" "$file"
done
